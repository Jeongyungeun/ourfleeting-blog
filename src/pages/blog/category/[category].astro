---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/Layout.astro";
import { Image } from "astro:assets";
import FormattedDate from "../../../components/FormattedDate.astro";

export async function getStaticPaths() {
	const allPosts = await getCollection("blog");

	// 카테고리 추출
	function getCategory(postId: string): string {
		const parts = postId.split("/");
		return parts.length > 1 ? parts[0] : "life";
	}

	// 모든 카테고리 목록
	const categories = [...new Set(allPosts.map(post => getCategory(post.id)))];

	// 각 카테고리별로 경로 생성
	return categories.map(category => ({
		params: { category },
		props: {
			category,
			posts: allPosts.filter(post => getCategory(post.id) === category)
				.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
			allCategories: ["all", ...categories]
		}
	}));
}

const { category, posts, allCategories } = Astro.props;

// 카테고리 이름 표시용
const categoryLabels: Record<string, string> = {
	all: "All",
	life: "Life",
	family: "Family",
	work: "Work",
};

// 카테고리별 태그 클래스
const tagClasses: Record<string, string> = {
	work: "tag-work",
	family: "tag-family",
	life: "tag-life",
};
---

<Layout title={`${categoryLabels[category] || category} - Blog`} description={`${categoryLabels[category] || category} 카테고리 글 목록`}>
	<div class="container-blog py-8 md:py-12">
		<!-- Page Header -->
		<div class="page-header">
			<h1 class="page-title">Blog</h1>
			<p class="page-description">일상의 소중한 순간들을 기록합니다</p>
		</div>

		<!-- Category Filter Tabs -->
		<div class="flex justify-center mb-10">
			<div class="filter-tabs bg-surface-secondary p-1.5 rounded-full">
				{allCategories.map((cat) => {
					const isActive = cat === category;
					return (
						<a
							href={cat === "all" ? "/blog" : `/blog/category/${cat}`}
							class:list={["filter-tab", { "active": isActive }]}
						>
							{categoryLabels[cat] || cat}
						</a>
					);
				})}
			</div>
		</div>

		<!-- Posts Grid -->
		{posts.length > 0 ? (
			<div class="posts-grid animate-stagger">
				{posts.map((post) => {
					const postCategory = category;
					return (
						<a href={`/blog/${post.id}/`} class="post-card group">
							{post.data.heroImage && (
								<div class="post-card-image">
									<Image
										src={post.data.heroImage}
										alt={post.data.title}
										width={600}
										height={450}
									/>
								</div>
							)}
							<div class="post-card-content">
								<div class="flex items-center gap-2 mb-3">
									<span class={`tag ${tagClasses[postCategory] || 'tag-life'}`}>
										{categoryLabels[postCategory] || postCategory}
									</span>
								</div>
								<h3 class="post-card-title">{post.data.title}</h3>
								<p class="post-card-excerpt">{post.data.description}</p>
								<div class="post-card-meta">
									<FormattedDate date={post.data.pubDate} />
								</div>
							</div>
						</a>
					);
				})}
			</div>
		) : (
			<div class="text-center py-16">
				<p class="text-text-secondary">이 카테고리에 글이 없습니다.</p>
			</div>
		)}
	</div>
</Layout>
